---
title: "Themen"
execute:
  echo: false
  warning: false
---


```{r}
#| include: false
library(tidyverse)
library(wordcloud2)
library(ggiraph)
source("config/viz_config.R")
source("R/quarto-utils.R")
source("R/utils.R")
source("R/viz.R")

ggplot2::theme_set(theme_ts) # defined in viz_config

tn <- readr::read_rds("data/cleaned/tn.rds")
tn_data <- tn$data
tn_cfg <- readr::read_rds("config/tn_cfg.rds")

og <- readr::read_rds("data/cleaned/og.rds")
og_data <- og$data
og_cfg <- readr::read_rds("config/og_cfg.rds")

tn_survey <- readr::read_csv("data/meta/tn_survey.csv")
tn_choices <- readr::read_csv("data/meta/tn_choices.csv")


meta_aussagen <- readr::read_csv("data/meta/tn/aussagen.csv")
meta_aussagen_choices <- readr::read_csv("data/meta/tn/aussagen_choices.csv") %>% 
  mutate(name = as.character(name))

fmt_aussage_label <- function(meta_data, aussage_short, inline = TRUE) {
  label <- meta_data$label[meta_data$name == aussage_short]
  if (length(label) == 0) stop(sprintf("Aussage %s does not exist.", aussage_short));
  s <- sprintf('%s', label)
  if (inline) {
    return(I(s))
  }
  return(s)
}

```

```{r aussagen-longify}
# long format 
aussagen_long <- tn$wide$aussagen %>% tidyr::pivot_longer(-tn_id, names_to = "aussage")
aussagen_long <- aussagen_long %>% left_join(meta_aussagen %>% rename(q_label = label), by = c("aussage" = "$autoname"))
aussagen_long <- aussagen_long %>% left_join(meta_aussagen_choices %>% rename(ch_label = label), by = c("value" = "name"))
```

```{r eig-data}
meta_eig <- readr::read_csv("data/meta/tn/eig.csv")
meta_eig_choices <- readr::read_csv("data/meta/tn/eig_choices.csv") %>% # here every question has its own scale
  mutate(value = as.character(name)) %>% 
  rename(label_value = label)

meta_eig <- meta_eig %>% 
  mutate(label_short = str_remove_all(label, "(Bei )?TEN SING.+?auf einer Skala"),
         label_short = str_remove_all(label_short, ":"),
         label_short = str_replace_all(label_short, "bis|und", "SEP"),
         label_short = str_replace_all(label_short, "von|zwischen", ""),
         label_short = str_remove_all(label_short, "\"")) %>% 
  mutate(y = 1:n())

eig_long <- tn$long$tensing_eigenschaften %>%
  left_join(meta_eig, by = c("eig" = "name")) %>% 
  left_join(meta_eig_choices, by = c("select_from_list_name" = "list_name", "value")) |> 
  rename(choice_label = label_value)
```


::: {.callout-note collapse="true"}
## Datenquellen

**Frage:** `{r} fmt_source(tn_cfg$Q_BEGIN_AUSSAGEN_LIKERT, "tn")`


**Frage:** `{r} fmt_source(tn_cfg$Q_BEGIN_EIGENSCHAFTEN, "tn")`

Spalten im Roh-Datensatz - Aussagen:

```{r}
tn_cfg$QS_AUSSAGEN_LIKERT %>% select(name, col_name)
```

Spalten im Roh-Datensatz - Eigenschaften:

```{r}
tn_cfg$QS_EIGENSCHAFTEN %>% select(name, col_name)
```

:::



```{r eig-utility-fun}
# we have to get the labels separately because there is no guarantee that all the values will be present in the data -> columns would be missing from the ggplot
get_eig_choice_labels <- function(choices_meta_df, list_name) {
  # filter out the labels for the y axis from the meta dataframe 
  eig_labels <- choices_meta_df |> 
    filter(list_name == .env$list_name) |> 
    pull(label_value)
}

get_eig_plot_data <- function(data_long, eig_choices_meta, eig) {
  data_eig <- data_long %>%
    dplyr::filter(eig == .env$eig)
  
  factor_levels <- get_eig_choice_labels(eig_choices_meta, data_eig$select_from_list_name[1])
  plot_data <- data_eig |>
    dplyr::group_by(eig, eig_label, value, select_from_list_name, choice_label, .drop = FALSE) %>%
    dplyr::summarize(n = n(), percent = n / length(unique(data_long$tn_id))) |> 
    dplyr::mutate(choice_label = factor(choice_label, levels = factor_levels, labels = factor_levels, ordered = TRUE))
  plot_data
}
```

 
# Glaube

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_offen_religionen")
eig_bar_chart(plot_data)
```


```{r}
# does the person have any contact to christian faith outside of TEN SING?
kontaktpunkt_data <- tn$long$kontakt_chrgl |> 
  group_by(tn_id) |> 
  summarize(has_kontaktpunkt = if_else(any(str_starts(kontaktpunkt, "Ja")), "Kontakt", "Kein Kontakt außerhalb von TEN SING")) |> 
  filter(!is.na(has_kontaktpunkt))

kontaktpunkt_pie <- get_pie_chart_data(kontaktpunkt_data, has_kontaktpunkt)
```

```{r}
glaube_rolle <- aussagen_long |> 
  filter(aussage == "glaube_spiritualitaet") |> 
  left_join(kontaktpunkt_data, by = "tn_id") |> 
  filter(!is.na(has_kontaktpunkt)) # filter out missings

glaube_rolle_q <- tn_cfg$QS_AUSSAGEN_LIKERT |> filter(name == "glaube_spiritualitaet")
glaube_rolle_agg <- janitor::tabyl(glaube_rolle, value, show_na = FALSE)
share_eher_yes <- sum(glaube_rolle_agg$percent[glaube_rolle_agg$value >= 4])
```

In der Mehrzahl setzen sich Aktive bei TEN SING mit ihrem Glauben auseinander. `{r} round(share_eher_yes * 100, 2)`% der Aktiven bewerten die Aussage "*`{r} glaube_rolle_q$label`*" eher bis voll und ganz zutreffend.
 
```{r}
aussage_bar_chart(aussagen_long, "aussage", "glaube_spiritualitaet")
```


**`{r} kontaktpunkt_pie$perc[kontaktpunkt_pie$has_kontaktpunkt == "Kontakt"]`%** der Aktiven haben außerhalb von TEN SING Kontakt zum christlichen Glauben, **`{r} kontaktpunkt_pie$perc[kontaktpunkt_pie$has_kontaktpunkt == "Kein Kontakt außerhalb von TEN SING"]`%** haben nur über TEN SING Kontakt. 



::: {.callout-tip collapse="true"}
## Tortendiagramm

```{r} 
kontakt_pie_plot <- ggplot(kontaktpunkt_pie, aes(x = "", y = n, fill = has_kontaktpunkt)) +
  geom_col() +
  ggrepel::geom_label_repel(
aes(y = pos, label = paste0(perc, "%")),
    size = 4.5,
    nudge_x = 1,
    show.legend = FALSE
  ) +
    coord_polar(theta = "y") +
  labs(title = "Kontakt zum christlichen Glauben",
subtitle = "außerhalb von Ten Sing",
       x = NULL,
       y = NULL,
       fill = NULL) +
         theme(panel.grid = element_blank(),
        axis.text.x = element_blank()) +
          scale_fill_manual(values = cols_4[c(1, 3, 4)])
        
        kontakt_pie_plot
```

:::

Es zeigt sich ein leichter Unterschied zwischen den Gruppen - Aktive, die auch außerhalb von TEN SING Kontakt mit dem christlichen Glauben haben, setzen sich eher auch bei TEN SING mit ihm auseinander. 

```{r}
glaube_rolle |> 
  group_by(has_kontaktpunkt, value) |> 
  tally(name = "nn") |>
  group_by(has_kontaktpunkt) |> 
  mutate(percent = nn / sum(nn)) |>
  ggplot(aes(x = value, fill = has_kontaktpunkt, y = percent, group = has_kontaktpunkt))+
  geom_col(position = "dodge")+
  scale_fill_manual(values = cols_4)+
  #scale_x_discrete(labels = meta_aussagen_choices$label)+
  scale_y_continuous(labels = scales::label_percent())+
  labs(y = "% Aktive", title = str_wrap(glaube_rolle_q$label, 60), x = "Bewertung",
  subtitle = "Bewertung von trifft überhaupt nicht zu (1) zu trifft voll und ganz zu (6)")
```





```{r}
offenheit_religionen <- eig_long |> 
  filter(eig == "tensing_offen_religionen") |> 
  inner_join(kontaktpunkt_data, by = "tn_id")

question <- offenheit_religionen$eig_label[1]
```
```{r}
offenheit_religionen |> 
  group_by(has_kontaktpunkt, value, .drop = TRUE) |> 
  tally(name = "nn") |>
  group_by(has_kontaktpunkt) |> 
  mutate(percent = nn / sum(nn)) |>
  ggplot(aes(x = value, fill = has_kontaktpunkt, y = percent, group = has_kontaktpunkt))+
  geom_col(position = "dodge")+
  scale_fill_manual(values = cols_4)+
  #scale_x_discrete(labels = meta_aussagen_choices$label)+
  scale_y_continuous(labels = scales::label_percent())+
  labs(y = "% Aktive", title = str_wrap(question, 60), x = "Bewertung", fill = NULL)+
  theme(legend.position = "bottom")
```


# Kreativität und Abwechslung
```{r}
aussage_bar_chart(aussagen_long, "aussage", "entfaltung_kreativitae")
```
```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_kreativ_unkreativ")
eig_bar_chart(plot_data)
```

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_abwechslung")
eig_bar_chart(plot_data)
```



# Offenheit und Fehlerkultur


```{r}
aussage_bar_chart(aussagen_long, "aussage", "ideeneinbringen")
```

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_modern_traditionell_00")
eig_bar_chart(plot_data)
```


```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_offen_exklusiv")
eig_bar_chart(plot_data)
```



```{r}
aussage_bar_chart(aussagen_long, "aussage", "fehlerkultur")
```

# Authentizität, Gemeinschaft und Safe Space


```{r}
aussage_bar_chart(aussagen_long, "aussage", "selbst_sein")
```

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tengsing_geschuetzt")
eig_bar_chart(plot_data)
```

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_achtenaufandere")
eig_bar_chart(plot_data)
```

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_gemeinschaft")
eig_bar_chart(plot_data)
```


# Selbstvertrauen und Selbstwirksamkeit

```{r}
aussage_bar_chart(aussagen_long, "aussage", "selbstbewusstsein")
```

```{r}
aussage_bar_chart(aussagen_long, "aussage", "dinge_zutrauen")
```

# Persönliche Entwicklung

```{r}
aussage_bar_chart(aussagen_long, "aussage", "eigene_entwicklung")
```

```{r}
plot_data <- get_eig_plot_data(eig_long, meta_eig_choices, "tensing_ausprobieren")
eig_bar_chart(plot_data)
```



# Lernen und Transfer

```{r}
aussage_bar_chart(aussagen_long, "aussage", "transfer")
```


```{r}
aussage_bar_chart(aussagen_long, "aussage", "neues_lernen")
```



